<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Manager</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --black: #121212;
            --dark-green: #1a472a;
            --green: #2e7d32;
            --light-green: #4caf50;
            --yellow: #ffd700;
            --light-yellow: #ffeb3b;
            --gray: #f5f5f5;
            --white: #ffffff;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--gray);
            color: var(--black);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(135deg, var(--dark-green), var(--green));
            color: var(--white);
            padding: 20px 0;
            margin-bottom: 30px;
            border-radius: 10px;
            box-shadow: var(--shadow);
        }
        
        header .container {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 24px;
            font-weight: 700;
        }
        
        .logo i {
            color: var(--yellow);
            font-size: 28px;
        }
        
        .card {
            background-color: var(--white);
            border-radius: 10px;
            box-shadow: var(--shadow);
            padding: 25px;
            margin-bottom: 25px;
            transition: var(--transition);
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        
        h1, h2 {
            color: var(--dark-green);
            margin-bottom: 20px;
            position: relative;
            display: inline-block;
        }
        
        h1::after, h2::after {
            content: '';
            position: absolute;
            left: 0;
            bottom: -5px;
            width: 40px;
            height: 3px;
            background-color: var(--yellow);
            transition: var(--transition);
        }
        
        h1:hover::after, h2:hover::after {
            width: 100%;
        }
        
        .flex-container {
            display: flex;
            gap: 25px;
            flex-wrap: wrap;
        }
        
        .flex-item {
            flex: 1;
            min-width: 300px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark-green);
        }
        
        input, button {
            width: 100%;
            padding: 12px 15px;
            border-radius: 6px;
            font-family: 'Poppins', sans-serif;
            font-size: 14px;
            transition: var(--transition);
        }
        
        input {
            border: 1px solid #ddd;
            background-color: var(--gray);
        }
        
        input:focus {
            outline: none;
            border-color: var(--green);
            box-shadow: 0 0 0 3px rgba(46, 125, 50, 0.2);
        }
        
        .btn {
            background-color: var(--green);
            color: var(--white);
            border: none;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn:hover {
            background-color: var(--dark-green);
            transform: translateY(-2px);
        }
        
        .btn-accent {
            background-color: var(--yellow);
            color: var(--black);
        }
        
        .btn-accent:hover {
            background-color: var(--light-yellow);
        }
        
        .file-upload {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 30px;
            border: 2px dashed var(--green);
            border-radius: 10px;
            background-color: rgba(76, 175, 80, 0.05);
            transition: var(--transition);
            cursor: pointer;
            margin-bottom: 15px;
        }
        
        .file-upload:hover {
            background-color: rgba(76, 175, 80, 0.1);
            border-color: var(--dark-green);
        }
        
        .file-upload i {
            font-size: 48px;
            color: var(--green);
            margin-bottom: 15px;
        }
        
        .file-upload input {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            opacity: 0;
            cursor: pointer;
        }
        
        .file-info {
            text-align: center;
        }
        
        .file-info h3 {
            font-weight: 500;
            margin-bottom: 5px;
        }
        
        .file-info p {
            color: #666;
            font-size: 14px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: var(--shadow);
        }
        
        th, td {
            padding: 15px;
            text-align: left;
        }
        
        th {
            background-color: var(--dark-green);
            color: var(--white);
            font-weight: 500;
        }
        
        tr {
            background-color: var(--white);
            transition: var(--transition);
        }
        
        tr:nth-child(even) {
            background-color: rgba(76, 175, 80, 0.05);
        }
        
        tr:hover {
            background-color: rgba(76, 175, 80, 0.1);
        }
        
        .actions {
            display: flex;
            gap: 10px;
        }
        
        .actions button {
            width: auto;
            padding: 8px 12px;
            font-size: 12px;
        }
        
        .btn-update {
            background-color: var(--green);
        }
        
        .btn-delete {
            background-color: #f44336;
        }
        
        .btn-view {
            background-color: var(--yellow);
            color: var(--black);
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 0;
            color: #666;
        }
        
        .empty-state i {
            font-size: 60px;
            color: #ddd;
            margin-bottom: 20px;
        }
        
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            background-color: var(--green);
            color: white;
        }
        
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: var(--dark-green);
            color: white;
            padding: 15px 25px;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 10px;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1000;
        }
        
        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        .toast i {
            font-size: 20px;
        }
        
        .toast.success {
            background-color: var(--green);
        }
        
        .toast.error {
            background-color: #f44336;
        }
        
        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .animate-fade-in {
            animation: fadeIn 0.5s ease forwards;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @media (max-width: 768px) {
            .flex-container {
                flex-direction: column;
            }
            
            .actions {
                flex-direction: column;
            }
            
            table {
                display: block;
                overflow-x: auto;
            }
        }
        
        .sortable {
            cursor: pointer;
            user-select: none;
        }
        .sortable:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        .sortable i {
            margin-left: 5px;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="logo">
                <i class="fas fa-file-pdf"></i>
                <span>PDF Manager</span>
            </div>
            <div id="user-info" style="display: none;">
                <span id="username"></span>
                <button id="logout-btn" class="btn btn-accent" style="width: auto; padding: 8px 15px; margin-left: 10px;">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Login/Register Section -->
        <div id="auth" class="animate-fade-in">
            <div class="flex-container">
                <div class="flex-item">
                    <div class="card">
                        <h2><i class="fas fa-sign-in-alt"></i> Login</h2>
                        <form id="login-form">
                            <div class="form-group">
                                <label for="login-username">Username</label>
                                <input type="text" id="login-username" name="username" placeholder="Enter your username" required>
                            </div>
                            <div class="form-group">
                                <label for="login-password">Password</label>
                                <input type="password" id="login-password" name="password" placeholder="Enter your password" required>
                            </div>
                            <button type="submit" class="btn">
                                <i class="fas fa-lock-open"></i> Login
                            </button>
                        </form>
                    </div>
                </div>
                <div class="flex-item">
                    <div class="card">
                        <h2><i class="fas fa-user-plus"></i> Register</h2>
                        <form id="register-form">
                            <div class="form-group">
                                <label for="register-username">Username</label>
                                <input type="text" id="register-username" name="username" placeholder="Choose a username" required>
                            </div>
                            <div class="form-group">
                                <label for="register-password">Password</label>
                                <input type="password" id="register-password" name="password" placeholder="Choose a password" required>
                            </div>
                            <button type="submit" class="btn btn-accent">
                                <i class="fas fa-user-check"></i> Register
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- PDF Management Section -->
        <div id="pdf-management" style="display: none;" class="animate-fade-in">
            <div class="card">
                <h2><i class="fas fa-cloud-upload-alt"></i> Upload PDF</h2>
                <form id="upload-form">
                    <div class="file-upload">
                        <i class="fas fa-file-pdf pulse"></i>
                        <div class="file-info">
                            <h3>Drag & Drop your PDFs here</h3>
                            <p>or click to browse files</p>
                            <p><small>You can upload up to 50 PDFs at once</small></p>
                        </div>
                        <input type="file" name="files"  multiple required>
                    </div>
                    <div class="form-group">
                        <label for="description">Description</label>
                        <input type="text" id="description" name="description" placeholder="Add a description (applies to all files)">
                    </div>
                    <button type="submit" class="btn">
                        <i class="fas fa-upload"></i> Upload PDFs
                    </button>
                </form>
            </div>

            <div class="card">
                <h2><i class="fas fa-file-alt"></i> Your PDFs</h2>
                <div class="form-group">
                    <input type="text" id="pdf-search" placeholder="Search PDFs by name or description..." 
                           style="margin-bottom: 15px;">
                </div>
                <div id="pdf-table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Filename</th>
                                <th>Description</th>
                                <th class="sortable" onclick="sortPDFs('upload_date')">
                                    Upload Date <i class="fas fa-sort"></i>
                                </th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="pdf-list"></tbody>
                    </table>
                </div>
                <div id="empty-state" class="empty-state" style="display: none;">
                    <i class="fas fa-folder-open"></i>
                    <h3>No PDFs found</h3>
                    <p>Upload your first PDF to get started</p>
                </div>
            </div>
        </div>
    </div>

    <div id="toast" class="toast">
        <i class="fas fa-check-circle"></i>
        <span id="toast-message"></span>
    </div>

    <script>
        let token = localStorage.getItem("token");
        let currentUsername = localStorage.getItem("username");

        // Toast notification function
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            
            toast.className = 'toast ' + type;
            toastMessage.textContent = message;
            
            // Show toast
            toast.classList.add('show');
            
            // Hide after 3 seconds
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function updateUI() {
            document.getElementById("auth").style.display = token ? "none" : "block";
            document.getElementById("pdf-management").style.display = token ? "block" : "none";
            
            if (token) {
                document.getElementById("user-info").style.display = "flex";
                document.getElementById("username").textContent = currentUsername || "User";
                fetchPDFs();
            } else {
                document.getElementById("user-info").style.display = "none";
            }
        }

        // File upload visual feedback
        const fileUpload = document.querySelector('.file-upload');
        const fileInput = fileUpload.querySelector('input[type="file"]');
        
        fileInput.addEventListener('change', function() {
            const fileInfo = fileUpload.querySelector('.file-info');
            
            if (this.files.length > 0) {
                const fileCount = this.files.length;
                fileInfo.innerHTML = `
                    <h3>${fileCount} ${fileCount === 1 ? 'file' : 'files'} selected</h3>
                    <p>${Array.from(this.files).map(file => file.name).join(', ')}</p>
                `;
                fileUpload.style.borderColor = 'var(--yellow)';
            } else {
                fileInfo.innerHTML = `
                    <h3>Drag & Drop your PDFs here</h3>
                    <p>or click to browse files</p>
                    <p><small>You can upload up to 10 PDFs at once</small></p>
                `;
                fileUpload.style.borderColor = 'var(--green)';
            }
        });

        // Register
        document.getElementById("register-form").addEventListener("submit", async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            
            try {
                const response = await fetch("/register", {
                    method: "POST",
                    body: JSON.stringify({
                        username: formData.get("username"),
                        password: formData.get("password")
                    }),
                    headers: { "Content-Type": "application/json" }
                });
                
                if (response.ok) {
                    showToast("Registration successful. Please login.");
                    e.target.reset();
                } else {
                    const errorData = await response.json();
                    showToast(errorData.detail || "Registration failed.", "error");
                }
            } catch (error) {
                showToast("Connection error. Please try again.", "error");
                console.error(error);
            }
        });

        // Login
        document.getElementById("login-form").addEventListener("submit", async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            
            try {
                const response = await fetch("/login", {
                    method: "POST",
                    body: new URLSearchParams({
                        username: formData.get("username"),
                        password: formData.get("password")
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    token = data.access_token;
                    currentUsername = formData.get("username");
                    localStorage.setItem("token", token);
                    localStorage.setItem("username", currentUsername);
                    showToast("Login successful!");
                    updateUI();
                } else {
                    const errorData = await response.json();
                    showToast(errorData.detail || "Login failed.", "error");
                }
            } catch (error) {
                showToast("Connection error. Please try again.", "error");
                console.error(error);
            }
        });

        // Logout
        document.getElementById("logout-btn").addEventListener("click", () => {
            localStorage.removeItem("token");
            localStorage.removeItem("username");
            token = null;
            currentUsername = null;
            showToast("Logged out successfully");
            updateUI();
        });

        // Upload PDF
        document.getElementById("upload-form").addEventListener("submit", async (e) => {
            e.preventDefault();
            const files = e.target.files.files;
            
            if (files.length === 0) {
                showToast("Please select at least one PDF file", "error");
                return;
            }

            const description = e.target.description.value;
            
            // Show loading state
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalBtnText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
            submitBtn.disabled = true;
            
            const uploadedPdfIds = [];
            let failedUploads = 0;

            for (const file of files) {
                const formData = new FormData();
                formData.append("file", file);
                if (description) {
                    formData.append("description", description);
                }
                
                try {
                    const response = await fetch("/upload", {
                        method: "POST",
                        headers: { "Authorization": `Bearer ${token}` },
                        body: formData
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        uploadedPdfIds.push(data.pdf_id);
                    } else {
                        failedUploads++;
                    }
                } catch (error) {
                    failedUploads++;
                    console.error(`Error uploading ${file.name}:`, error);
                }
            }
            
            // Reset form and file upload visual
            e.target.reset();
            const fileInfo = fileUpload.querySelector('.file-info');
            fileInfo.innerHTML = `
                <h3>Drag & Drop your PDFs here</h3>
                <p>or click to browse files</p>
                <p><small>You can upload up to 10 PDFs at once</small></p>
            `;
            fileUpload.style.borderColor = 'var(--green)';
            
            // Reset button state
            submitBtn.innerHTML = originalBtnText;
            submitBtn.disabled = false;
            
            if (uploadedPdfIds.length > 0) {
                showToast(`Uploaded ${uploadedPdfIds.length} files. Processing in background.`);
                
                // Add status monitoring for uploaded PDFs
                monitorPdfProcessing(uploadedPdfIds);
                
                // Refresh the list to show pending PDFs
                fetchPDFs();
            }
            
            if (failedUploads > 0) {
                showToast(`${failedUploads} uploads failed`, "error");
            }
        });

        // Add function to monitor PDF processing status
        async function monitorPdfProcessing(pdfIds) {
            const checkStatus = async () => {
                let allCompleted = true;
                
                for (const pdfId of pdfIds) {
                    try {
                        const response = await fetch(`/pdfs/${pdfId}/status`, {
                            headers: { "Authorization": `Bearer ${token}` }
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            if (data.status === "pending") {
                                allCompleted = false;
                            } else if (data.status === "error") {
                                showToast(`Error processing PDF: ${data.error_message || "Unknown error"}`, "error");
                            }
                        }
                    } catch (error) {
                        console.error(`Error checking status for PDF ${pdfId}:`, error);
                    }
                }
                
                if (allCompleted) {
                    showToast("All PDFs processed successfully!");
                    fetchPDFs();
                    return;
                }
                
                // Check again after 3 seconds
                setTimeout(checkStatus, 3000);
            };
            
            // Start checking
            setTimeout(checkStatus, 3000);
        }

        // Format date
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric'
            });
        }

        // Add these variables for sorting state
        let currentSort = {
            column: 'upload_date',
            direction: 'desc'
        };

        // Add the sorting function
        function sortPDFs(column) {
            if (currentSort.column === column) {
                // Toggle direction if clicking the same column
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                // Default to descending for new column
                currentSort.column = column;
                currentSort.direction = 'desc';
            }

            // Update sort icon
            const sortIcon = document.querySelector(`th[onclick="sortPDFs('${column}')"] i`);
            sortIcon.className = `fas fa-sort-${currentSort.direction}`;

            fetchPDFs();
        }

        // Update the fetchPDFs function
        async function fetchPDFs() {
            try {
                const response = await fetch("/pdfs", {
                    headers: { "Authorization": `Bearer ${token}` }
                });
                
                if (!response.ok) {
                    throw new Error("Failed to fetch PDFs");
                }
                
                const pdfs = await response.json();
                const list = document.getElementById("pdf-list");
                const emptyState = document.getElementById("empty-state");
                const tableContainer = document.getElementById("pdf-table-container");
                
                // Sort PDFs based on current sort settings
                pdfs.sort((a, b) => {
                    const dateA = new Date(a.upload_date);
                    const dateB = new Date(b.upload_date);
                    return currentSort.direction === 'asc' 
                        ? dateA - dateB 
                        : dateB - dateA;
                });
                
                list.innerHTML = "";
                
                if (pdfs.length === 0) {
                    emptyState.style.display = "block";
                    tableContainer.style.display = "none";
                    return;
                }
                
                emptyState.style.display = "none";
                tableContainer.style.display = "block";
                
                pdfs.forEach((pdf, index) => {
                    const tr = document.createElement("tr");
                    tr.style.animationDelay = `${index * 0.05}s`;
                    tr.classList.add('animate-fade-in');
                    
                    // Add status indicator
                    const statusBadge = pdf.status === "pending" 
                        ? `<span class="badge" style="background-color: orange;"><i class="fas fa-spinner fa-spin"></i> Processing</span>`
                        : pdf.status === "error"
                            ? `<span class="badge" style="background-color: #f44336;"><i class="fas fa-exclamation-circle"></i> Error</span>`
                            : `<span class="badge" style="background-color: var(--green);"><i class="fas fa-check"></i> Processed</span>`;
                    
                    tr.innerHTML = `
                        <td>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <i class="fas fa-file-pdf" style="color: var(--green);"></i>
                                ${pdf.filename}
                                ${statusBadge}
                            </div>
                        </td>
                        <td>${pdf.description || "<em>No description</em>"}</td>
                        <td>${formatDate(pdf.upload_date)}</td>
                        <td class="actions">
                            <button onclick="viewPDF(${pdf.id})" class="btn btn-view" ${pdf.status !== "processed" ? "disabled" : ""}>
                                <i class="fas fa-eye"></i> View
                            </button>
                            <button onclick="updatePDF(${pdf.id})" class="btn btn-update">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button onclick="deletePDF(${pdf.id})" class="btn btn-delete">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </td>
                    `;
                    list.appendChild(tr);
                });
            } catch (error) {
                showToast("Failed to load PDFs", "error");
                console.error(error);
            }
        }

        // View PDF
        function viewPDF(pdfId) {
            window.open(`/pdfs/${pdfId}/view`, '_blank');
        }

        // Update PDF
        async function updatePDF(pdfId) {
            const description = prompt("Enter new description:");
            if (description !== null) {
                try {
                    const response = await fetch(`/pdfs/${pdfId}`, {
                        method: "PUT",
                        headers: {
                            "Authorization": `Bearer ${token}`,
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({ description: description })
                    });
                    
                    if (response.ok) {
                        showToast("PDF updated successfully");
                        fetchPDFs();
                    } else {
                        const error = await response.json();
                        showToast("Update failed: " + (error.detail || "Unknown error"), "error");
                    }
                } catch (error) {
                    showToast("Connection error. Please try again.", "error");
                    console.error(error);
                }
            }
        }

        // Delete PDF
        async function deletePDF(pdfId) {
            if (confirm("Are you sure you want to delete this PDF?")) {
                try {
                    const response = await fetch(`/pdfs/${pdfId}`, {
                        method: "DELETE",
                        headers: { "Authorization": `Bearer ${token}` }
                    });
                    
                    if (response.ok) {
                        showToast("PDF deleted successfully");
                        fetchPDFs();
                    } else {
                        showToast("Delete failed", "error");
                    }
                } catch (error) {
                    showToast("Connection error. Please try again.", "error");
                    console.error(error);
                }
            }
        }

        // Fix the search event listener
        document.getElementById("pdf-search").addEventListener("input", function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const rows = document.querySelectorAll("#pdf-list tr");
            let visibleCount = 0;
            
            rows.forEach(row => {
                const filename = row.querySelector("td:nth-child(1)").textContent.toLowerCase();
                const description = row.querySelector("td:nth-child(2)").textContent.toLowerCase();
                const shouldShow = filename.includes(searchTerm) || description.includes(searchTerm);
                
                row.style.display = shouldShow ? "" : "none";
                if (shouldShow) visibleCount++;
            });
            
            // Show empty state if no results
            const emptyState = document.getElementById("empty-state");
            const tableContainer = document.getElementById("pdf-table-container");
            
            if (visibleCount === 0) {
                emptyState.style.display = "block";
                emptyState.querySelector("h3").textContent = "No PDFs match your search";
                emptyState.querySelector("p").textContent = "Try a different search term";
                tableContainer.style.display = "block";
                document.querySelector("table").style.display = "none";
            } else {
                emptyState.style.display = "none";
                document.querySelector("table").style.display = "table";
                tableContainer.style.display = "block";
            }
        });

        // Initial UI update
        updateUI();
    </script>
</body>
</html>